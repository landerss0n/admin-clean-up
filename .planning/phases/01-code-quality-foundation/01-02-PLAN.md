---
phase: 01-code-quality-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - includes/class-admin-page.php
  - includes/class-plugin-notices.php
  - admin-clean-up.php
  - languages/admin-clean-up.pot
  - languages/admin-clean-up-sv_SE.po
  - languages/admin-clean-up-sv_SE.mo
autonomous: true

must_haves:
  truths:
    - "With PixelYourSite Pro active and Free inactive, the PYS tab does not appear and no notice-hiding hooks fire"
    - "With PixelYourSite Free active and Pro inactive, the PYS tab appears and notice-hiding works normally"
    - "All user-facing strings render in English by default"
    - "Switching WordPress locale to sv_SE shows Swedish translations for all strings"
  artifacts:
    - path: "includes/class-admin-page.php"
      provides: "PYS Free-only detection in get_installed_supported_plugins()"
      contains: "pixelyoursite-pro"
    - path: "includes/class-plugin-notices.php"
      provides: "PYS Pro exclusion check before hooking notice hiding"
      contains: "pixelyoursite-pro"
    - path: "admin-clean-up.php"
      provides: "load_plugin_textdomain() call on init action"
      contains: "load_plugin_textdomain"
    - path: "languages/admin-clean-up.pot"
      provides: "Updated translation template with all extractable strings"
    - path: "languages/admin-clean-up-sv_SE.po"
      provides: "Swedish translations for all strings"
    - path: "languages/admin-clean-up-sv_SE.mo"
      provides: "Compiled Swedish translations"
  key_links:
    - from: "includes/class-admin-page.php::get_installed_supported_plugins()"
      to: "is_plugin_active()"
      via: "checks both Free path AND excludes Pro path"
      pattern: "pixelyoursite-pro/pixelyoursite-pro.php"
    - from: "includes/class-plugin-notices.php::__construct()"
      to: "is_plugin_active()"
      via: "checks Free active AND Pro not active before hooking"
      pattern: "pixelyoursite-pro/pixelyoursite-pro.php"
    - from: "admin-clean-up.php::__construct()"
      to: "load_plugin_textdomain()"
      via: "init action hook loads translations"
      pattern: "add_action.*init.*load_textdomain"
---

<objective>
Add PYS Pro exclusion condition so notice-hiding only activates with the Free version, and add proper translation loading support with updated .pot/.po/.mo files.

Purpose: Prevents the plugin from hiding notices when only PYS Pro is installed (Pro doesn't show nag screens, so hiding is unnecessary and the tab should not appear). Ensures translations load correctly by calling load_plugin_textdomain() on init.

Output: Updated class-admin-page.php and class-plugin-notices.php with Pro exclusion, updated admin-clean-up.php with textdomain loading, regenerated translation files.
</objective>

<execution_context>
@/Users/lucas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-code-quality-foundation/01-RESEARCH.md
@.planning/phases/01-code-quality-foundation/01-01-SUMMARY.md

@admin-clean-up.php
@includes/class-admin-page.php
@includes/class-plugin-notices.php
@languages/admin-clean-up-sv_SE.po
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PYS Pro exclusion to both detection points</name>
  <files>includes/class-admin-page.php, includes/class-plugin-notices.php</files>
  <action>
**In class-admin-page.php -- `get_installed_supported_plugins()` method:**

Currently the method checks `is_plugin_active( $plugin['check'] )` where check is `'pixelyoursite/facebook-pixel-master.php'`. This correctly detects the Free version but doesn't exclude Pro.

Add a `'pro_check'` key to the supported plugins array in `get_supported_plugins()`:
```php
'pixelyoursite' => [
    'name'      => 'PixelYourSite',
    'check'     => 'pixelyoursite/facebook-pixel-master.php',
    'pro_check' => 'pixelyoursite-pro/pixelyoursite-pro.php',
    'option'    => 'hide_pixelyoursite_notices',
],
```

Then in `get_installed_supported_plugins()`, update the loop condition:
```php
foreach ( $supported as $key => $plugin ) {
    if ( is_plugin_active( $plugin['check'] ) ) {
        // If plugin has a pro version, exclude when pro is active
        if ( ! empty( $plugin['pro_check'] ) && is_plugin_active( $plugin['pro_check'] ) ) {
            continue;
        }
        $installed[ $key ] = $plugin;
    }
}
```

This means: Free is active AND Pro is NOT active = show the tab. If Pro is active (whether Free is also active or not), skip it.

**In class-plugin-notices.php -- `__construct()` method:**

Currently checks:
```php
if ( ! empty( $plugins_options['hide_pixelyoursite_notices'] ) && $this->is_plugin_active( 'pixelyoursite/facebook-pixel-master.php' ) ) {
```

Add Pro exclusion:
```php
if ( ! empty( $plugins_options['hide_pixelyoursite_notices'] )
    && $this->is_plugin_active( 'pixelyoursite/facebook-pixel-master.php' )
    && ! $this->is_plugin_active( 'pixelyoursite-pro/pixelyoursite-pro.php' ) ) {
```

This ensures the CSS hiding hook only fires when Free is active and Pro is NOT active.
  </action>
  <verify>
Run: `grep -n "pixelyoursite-pro" includes/class-admin-page.php includes/class-plugin-notices.php`
Expected: At least 1 occurrence in each file.

Run: `php -l includes/class-admin-page.php && php -l includes/class-plugin-notices.php`
Expected: No syntax errors.
  </verify>
  <done>
- get_supported_plugins() has 'pro_check' key for pixelyoursite
- get_installed_supported_plugins() skips plugins where pro_check is active
- class-plugin-notices.php constructor checks Pro is NOT active before hooking
- With Pro active (Free inactive): tab hidden, no hooks fire
- With Free active (Pro inactive): tab visible, hooks fire normally
- With both active: Pro takes precedence, tab hidden (Pro doesn't show nags)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add textdomain loading and update translation files</name>
  <files>admin-clean-up.php, languages/admin-clean-up.pot, languages/admin-clean-up-sv_SE.po, languages/admin-clean-up-sv_SE.mo</files>
  <action>
**1. Add load_textdomain method and hook in admin-clean-up.php:**

In the WP_Clean_Up class constructor, add an init action:
```php
private function __construct() {
    add_action( 'init', [ $this, 'load_textdomain' ] );
    $this->load_dependencies();
    $this->init_modules();
}
```

Add the method (public, since it's a hook callback):
```php
/**
 * Load plugin text domain for translations.
 */
public function load_textdomain() {
    load_plugin_textdomain(
        'admin-clean-up',
        false,
        dirname( plugin_basename( __FILE__ ) ) . '/languages'
    );
}
```

**2. Regenerate the .pot file:**

Check if wp-cli is available:
```bash
wp --version 2>/dev/null || echo "WP-CLI not available"
```

If WP-CLI IS available with i18n command:
```bash
cd /Users/lucas/Sites/admin-clean-up && wp i18n make-pot . languages/admin-clean-up.pot --domain=admin-clean-up --skip-js
```

If WP-CLI is NOT available: The existing .pot file is acceptable since all strings already use the correct text domain. The .pot just needs the textdomain loading string added. In this case, manually add the new translatable string entry to the .pot file (the load_textdomain method itself has no translatable strings, so .pot content is actually unchanged).

IMPORTANT: Since Plan 01 converted all form field `name` attributes from static strings to PHP echo statements, the .pot extraction should still find all `__()` and `_e()` calls correctly (those haven't changed, only the HTML name attributes changed).

**3. Update the .po file:**

If WP-CLI IS available:
```bash
cd /Users/lucas/Sites/admin-clean-up && wp i18n update-po languages/admin-clean-up.pot languages/admin-clean-up-sv_SE.po
```

If WP-CLI is NOT available: The existing .po file should be valid as-is since no new translatable strings were added (the form name attributes are not translatable strings). Verify the .po file has translations for all msgid entries from the source.

**4. Compile the .mo file:**

If WP-CLI IS available:
```bash
cd /Users/lucas/Sites/admin-clean-up && wp i18n make-mo languages/admin-clean-up-sv_SE.po languages/admin-clean-up-sv_SE.mo
```

If WP-CLI is NOT available, try msgfmt:
```bash
msgfmt -o languages/admin-clean-up-sv_SE.mo languages/admin-clean-up-sv_SE.po
```

If neither tool is available: The existing .mo file is acceptable since no translatable strings changed content. Document this as a known limitation.

**5. Verify no hardcoded Swedish strings exist in PHP source files:**

Search all PHP files for common Swedish words that might be hardcoded:
```bash
grep -rn "Inställningar\|Kommentarer\|Meddelanden\|menyer\|uppdateringar" --include="*.php" . | grep -v ".po\|.pot\|.mo\|vendor"
```

If any are found in PHP source (not translation files), they represent hardcoded Swedish that must be replaced with `__('English equivalent', 'admin-clean-up')`.
  </action>
  <verify>
Run: `grep -n "load_plugin_textdomain\|load_textdomain" admin-clean-up.php`
Expected: load_textdomain method definition and add_action hook.

Run: `php -l admin-clean-up.php`
Expected: No syntax errors.

Run: `test -f languages/admin-clean-up.pot && echo "POT exists" || echo "POT missing"`
Expected: POT exists.

Run: `test -f languages/admin-clean-up-sv_SE.mo && echo "MO exists" || echo "MO missing"`
Expected: MO exists.

Run: `grep -rn "Inställningar\|Kommentarer\|Meddelanden" --include="*.php" . | grep -v "languages/"`
Expected: No matches (no hardcoded Swedish in source PHP).
  </verify>
  <done>
- load_plugin_textdomain() called on init action in WP_Clean_Up constructor
- Text domain 'admin-clean-up' loads from /languages directory
- .pot file exists and is current
- .po file has Swedish translations for all strings
- .mo file is compiled and loadable
- No hardcoded Swedish strings exist in PHP source files
  </done>
</task>

</tasks>

<verification>
1. `grep -n "pixelyoursite-pro" includes/class-admin-page.php includes/class-plugin-notices.php` -- Both files reference Pro path
2. `grep -n "load_plugin_textdomain" admin-clean-up.php` -- Method exists and is called
3. `php -l admin-clean-up.php && php -l includes/class-admin-page.php && php -l includes/class-plugin-notices.php` -- No syntax errors
4. `grep -rn "Inställningar\|Kommentarer\|Meddelanden" --include="*.php" . | grep -v "languages/"` -- No hardcoded Swedish
5. Translation files exist: .pot, .po, .mo all present in languages/
</verification>

<success_criteria>
- PYS Pro exclusion: Both detection points (tab visibility + notice hiding) check that Pro is NOT active
- Text domain loading: load_plugin_textdomain() fires on init
- Translation files: .pot, .po, and .mo files exist and are current
- No hardcoded Swedish: All user-facing strings use __() or _e() with 'admin-clean-up' domain
- English default: Without locale switch, all strings display in English
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-quality-foundation/01-02-SUMMARY.md`
</output>
